# Debug

## Description

```Do you think you can Debug this program you better think TWICE.``

## Attachment:
[Chall](./challenge/chall)

## Solution:

Let's open the binary in Ghidra

```C
undefined8 main(void) {
  byte abStack256 [8];
  undefined8 local_f8;
  undefined8 local_f0;
  undefined4 local_e8;
  char local_e2 [10];
  long local_d8 [8];
  char local_98 [80];
  ulong *local_48;
  FILE *local_40;
  int local_34;
  int local_30;
  uint local_2c;
  code *local_28;
  uint local_1c;
  uint local_18;
  int local_14;
  int local_10;
  uint local_c;
  
  local_28 = main;
  local_2c = 0;
  local_10 = 0;
  local_14 = 0;
  local_f8 = 0x4654436168706c41;
  local_f0 = 0x5f;
  local_e8 = 0;
  local_30 = globalvar;

  for (local_18 = 0; local_18 < 8; local_18 = local_18 + 1) {
    abStack256[(int)local_18] = (byte)(globalvar >> ((byte)(local_18 << 3) & 0x1f));
  }

  setbuf(stdin,(char *)0x0);
  setbuf(stdout,(char *)0x0);
  puts("Give me the password dude:");
  fgets((char *)local_d8,0x40,stdin);

  for (; *(char *)((long)local_d8 + (long)local_14) != '\n'; local_14 = local_14 + 1) {}

  *(undefined *)((long)local_d8 + (long)local_14) = 0;

  for (local_1c = 0; *(char *)((long)local_d8 + (long)(int)local_1c) != '\0'; local_1c = local_1c + 1) {
    *(byte *)((long)local_d8 + (long)(int)local_1c) = *(byte *)((long)local_d8 + (long)(int)local_1c) ^ abStack256[local_1c & 7];
  }

  res = local_d8[0];
  while (local_c != 0xc3) {
    local_48 = (ulong *)(local_28 + local_10);
    local_2c = (uint)*local_48;
    local_c = local_2c & 0xff;
    if ((*local_48 & 0xff) != 0) {
      res = res + (int)(local_c << 4);
    }
    local_10 = local_10 + 1;
  }

  sprintf(local_e2,"%lx",res);
  strcat((char *)&local_f8,local_e2);
  local_34 = strncmp((char *)&local_f8,"AlphaCTF_a4cf9924a7a50fe9",0x11);

  if (local_34 == 0) {
    local_40 = fopen("flag.txt","r");
    fgets(local_98,0x47,local_40);
    printf("Good job dude here is your prize: %s\n",local_98);
    fclose(local_40);
  } else {
    puts("Nah not the write password try harder!!");
  }
  return 0;
}
```

After analysing the code generated by Ghidra, we can see that at the beginning it makes a XOR operation between the input an a XOR key

Then the sum of the hex numbers from the start of the main to the first `0xc3` are added to the xored input

Then `AlphaCTF_` is added the final result and compared to `AlphaCTF_a4cf9924a7a50fe9`

Let's try to run the script now to get the correct, the reversed result seems incorrect and i think we missed something

Now we try to run `strace` command to check if there's anything unusual

we can notice there's `ptrace(PTRACE_TRACEME)` which means it detects when a debuger is running

Let's find where the syscall is made, we can find in `void __do_global_ctors_aux` function

```C
void __do_global_ctors_aux(void) {
  syscall();
  return;
}
```
Let's check the assembly code now

```asm
    PUSH       RBP
    MOV        RBP,RSP
    MOV        EAX,0x65
    MOV        ESI,0x0
    MOV        EDI,0x0
    MOV        EDX,0x0
    SYSCALL
    MOV        qword ptr [RBP + local_20],RAX
    CMP        qword ptr [RBP + local_20],0x0
    JNZ        LAB_0010121f
    JMP        LAB_001011ff

    LAB_001011e0
    MOV        EAX,dword ptr [RBP + local_14]
    CDQE
    LEA        RDX,[RAX*0x8]
    LEA        RAX,[data_start]
    ADD        RAX,RDX
    MOV        qword ptr [RBP + local_10],RAX
    ADD        dword ptr [RBP + local_14],0x1

    LAB_001011ff
    CMP        dword ptr [RBP + local_14],0xff
    JG         LAB_00101215
    MOV        RAX,qword ptr [RBP + local_10]
    MOV        EAX,dword ptr [RAX]
    CMP        EAX,0x13371337
    JNZ        LAB_001011e0

    LAB_00101215 
    MOV        RAX,qword ptr [RBP + local_10]
    MOV        dword ptr [RAX],

    LAB_0010121f
    NOP
    POP        RBP
    RET
```

After anaylysing it we can notice that in case a debugger is not detected the value of XOR key is changed to `0xc3badb17`

Now let's retry to run the script

Now we got a readable password `N0-d3Bug`

Let's submit and get the flag

## Flag:
AlphaCTF{x0R_pTR4c3_w1tH0ut_bR3ak!\_m4n_g00dJOb}